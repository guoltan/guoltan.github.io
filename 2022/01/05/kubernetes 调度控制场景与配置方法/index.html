<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"guoltan.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="kubernetes的调度和驱逐kubernetes的调度  我们在节点上创建Pod的时候，实际上是通过 kube-scheduler 进行了一系列的调度打分等动作才决定了Pod能够运行在哪个节点上。首先kube-scheduler会先进行过滤。Pod本身可能具备一些需求。要求会运行到特定的节点上。此时通过过滤器可以筛选出可调度的节点。在可调度节点的基础上。kube-scheduler 再根据内置">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes 调度和驱逐">
<meta property="og:url" content="https://guoltan.github.io/2022/01/05/kubernetes%20%E8%B0%83%E5%BA%A6%E6%8E%A7%E5%88%B6%E5%9C%BA%E6%99%AF%E4%B8%8E%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95/index.html">
<meta property="og:site_name" content="guoltan个人博客">
<meta property="og:description" content="kubernetes的调度和驱逐kubernetes的调度  我们在节点上创建Pod的时候，实际上是通过 kube-scheduler 进行了一系列的调度打分等动作才决定了Pod能够运行在哪个节点上。首先kube-scheduler会先进行过滤。Pod本身可能具备一些需求。要求会运行到特定的节点上。此时通过过滤器可以筛选出可调度的节点。在可调度节点的基础上。kube-scheduler 再根据内置">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-01-05T10:00:15.000Z">
<meta property="article:modified_time" content="2024-03-25T15:56:51.420Z">
<meta property="article:author" content="guoltan">
<meta property="article:tag" content="K8S">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://guoltan.github.io/2022/01/05/kubernetes%20%E8%B0%83%E5%BA%A6%E6%8E%A7%E5%88%B6%E5%9C%BA%E6%99%AF%E4%B8%8E%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://guoltan.github.io/2022/01/05/kubernetes%20%E8%B0%83%E5%BA%A6%E6%8E%A7%E5%88%B6%E5%9C%BA%E6%99%AF%E4%B8%8E%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95/","path":"2022/01/05/kubernetes 调度控制场景与配置方法/","title":"Kubernetes 调度和驱逐"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Kubernetes 调度和驱逐 | guoltan个人博客</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="guoltan个人博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">guoltan个人博客</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#kubernetes%E7%9A%84%E8%B0%83%E5%BA%A6%E5%92%8C%E9%A9%B1%E9%80%90"><span class="nav-number">1.</span> <span class="nav-text">kubernetes的调度和驱逐</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#kubernetes%E7%9A%84%E8%B0%83%E5%BA%A6"><span class="nav-number">1.1.</span> <span class="nav-text">kubernetes的调度</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B1%A1%E7%82%B9%E4%B8%8E%E5%AE%B9%E5%BF%8D"><span class="nav-number">1.2.</span> <span class="nav-text">污点与容忍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%B1%A1%E7%82%B9%EF%BC%9F"><span class="nav-number">1.2.1.</span> <span class="nav-text">什么是污点？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B1%A1%E7%82%B9%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">1.2.2.</span> <span class="nav-text">污点的应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B1%A1%E7%82%B9%E7%9A%84%E9%85%8D%E7%BD%AE%E6%94%AF%E6%8C%81%E4%B8%8B%E9%9D%A2%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.2.3.</span> <span class="nav-text">污点的配置支持下面三种类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B1%A1%E7%82%B9%E7%9A%84%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.2.4.</span> <span class="nav-text">污点的配置示例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E6%B1%A1%E7%82%B9%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">添加污点示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A7%BB%E9%99%A4%E6%B1%A1%E7%82%B9%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">移除污点示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B1%A1%E7%82%B9%E4%BD%9C%E7%94%A8%E6%B5%8B%E8%AF%95"><span class="nav-number">1.2.4.3.</span> <span class="nav-text">污点作用测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B1%A1%E7%82%B9%E9%85%8D%E7%BD%AE%E6%A1%88%E4%BE%8B"><span class="nav-number">1.2.4.4.</span> <span class="nav-text">污点配置案例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E5%BF%8D%E7%9A%84%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.2.5.</span> <span class="nav-text">容忍的配置示例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%B9%E5%BF%8D%E9%85%8D%E7%BD%AE%E6%A1%88%E4%BE%8B"><span class="nav-number">1.2.5.1.</span> <span class="nav-text">容忍配置案例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%B2%E5%92%8C%E6%80%A7%E4%B8%8E%E5%8F%8D%E4%BA%B2%E5%92%8C%E6%80%A7"><span class="nav-number">1.3.</span> <span class="nav-text">亲和性与反亲和性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#nodeName%E4%BB%A5%E5%8F%8AnodeSelector"><span class="nav-number">1.3.1.</span> <span class="nav-text">nodeName以及nodeSelector</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E4%BF%AE%E6%94%B9-nodeSelecctor-%E9%85%8D%E7%BD%AE"><span class="nav-number">1.3.2.</span> <span class="nav-text">基于命名空间修改 nodeSelecctor 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E4%BA%B2%E5%92%8C%E9%85%8D%E7%BD%AE%E5%AE%9E%E7%8E%B0Pod%E8%B0%83%E5%BA%A6"><span class="nav-number">1.3.3.</span> <span class="nav-text">通过亲和配置实现Pod调度</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E8%8A%82%E7%82%B9%E7%9A%84%E4%BA%B2%E5%92%8C%E6%80%A7%E8%B0%83%E5%BA%A6"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">基于节点的亲和性调度</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8ErequiredDuringSchedulingIgnoredDuringExecution%E5%AE%9E%E7%8E%B0%E8%8A%82%E7%82%B9%E4%BA%B2%E5%92%8C"><span class="nav-number">1.3.3.1.1.</span> <span class="nav-text">基于requiredDuringSchedulingIgnoredDuringExecution实现节点亲和</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8EpreferredDuringSchedulingIgnoredDuringExecution%E5%AE%9E%E7%8E%B0%E8%8A%82%E7%82%B9%E4%BA%B2%E5%92%8C"><span class="nav-number">1.3.3.1.2.</span> <span class="nav-text">基于preferredDuringSchedulingIgnoredDuringExecution实现节点亲和</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E4%BA%B2%E5%92%8C%E6%80%A7%E7%9A%84%E9%85%8D%E7%BD%AE%E6%A1%88%E4%BE%8B"><span class="nav-number">1.3.3.1.3.</span> <span class="nav-text">节点亲和性的配置案例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8EPod%E7%9A%84%E4%BA%B2%E5%92%8C%E6%80%A7%E8%B0%83%E5%BA%A6"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">基于Pod的亲和性调度</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Pod%E4%BA%B2%E5%92%8C%E6%80%A7%E8%B0%83%E5%BA%A6%E7%9A%84%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.3.3.2.1.</span> <span class="nav-text">Pod亲和性调度的配置示例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pod-%E6%8B%93%E6%89%91%E7%BA%A6%E6%9D%9F"><span class="nav-number">1.3.4.</span> <span class="nav-text">Pod 拓扑约束</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">guoltan</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">24</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/guoltan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;guoltan" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:897156356@qq.com" title="E-Mail → mailto:897156356@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://guoltan.github.io/2022/01/05/kubernetes%20%E8%B0%83%E5%BA%A6%E6%8E%A7%E5%88%B6%E5%9C%BA%E6%99%AF%E4%B8%8E%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="guoltan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="guoltan个人博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Kubernetes 调度和驱逐 | guoltan个人博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kubernetes 调度和驱逐
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-01-05 18:00:15" itemprop="dateCreated datePublished" datetime="2022-01-05T18:00:15+08:00">2022-01-05</time>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>25k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>46 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="kubernetes的调度和驱逐"><a href="#kubernetes的调度和驱逐" class="headerlink" title="kubernetes的调度和驱逐"></a>kubernetes的调度和驱逐</h1><h2 id="kubernetes的调度"><a href="#kubernetes的调度" class="headerlink" title="kubernetes的调度"></a>kubernetes的调度</h2><p>  我们在节点上创建Pod的时候，实际上是通过 kube-scheduler 进行了一系列的调度打分等动作才决定了Pod能够运行在哪个节点上。首先kube-scheduler会先进行过滤。Pod本身可能具备一些需求。要求会运行到特定的节点上。此时通过过滤器可以筛选出可调度的节点。在可调度节点的基础上。kube-scheduler 再根据内置的函数对节点进行打分。通过打分以后。选取最合适的节点。将该节点通知给 kube-apiserver。让 kube-apiserver 知道后续创建Pod到哪台节点上。</p>
<p>  有关kubernetes默认支持的调度函数，打分函数可以参考链接。</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/scheduling/policies/">https://kubernetes.io/zh/docs/reference/scheduling/policies/</a></p>
<h2 id="污点与容忍"><a href="#污点与容忍" class="headerlink" title="污点与容忍"></a>污点与容忍</h2><h3 id="什么是污点？"><a href="#什么是污点？" class="headerlink" title="什么是污点？"></a><strong>什么是污点？</strong></h3><p>  通过给节点添加污点，可以阻止Pod创建在带有污点的节点上。管理员可以通过合理的设置污点。来控制业务Pod的运行。如：管理员不希望业务Pod运行在master节点上。这种需要就可以通过在master节点上添加污点来实现。事实上kubernetes默认也为master添加上了 <code>node-role.kubernetes.io/master:NoSchedule</code> 的污点。避免业务Pod直接运行在master节点上。</p>
<p>  通过污点我们可以阻止Pod运行到带污点的节点上,如果希望Pod能运行到这些带污点的节点上则需要给Pod添加容忍配置。通过设置容忍能够让Pod支持调度到带有污点的节点。</p>
<h3 id="污点的应用场景"><a href="#污点的应用场景" class="headerlink" title="污点的应用场景"></a><strong>污点的应用场景</strong></h3><ul>
<li>通过污点规划专用节点，避免Pod被直接调度到该类节点上。比方说带有GPU设备的节点。可以打上一个特定污点。只要未设置该类污点容忍配置的Pod都无法被调度到这类GPU节点上。只有需要使用GPU资源的Pod配置了容忍才能被调度到。通过这种方法可以实现Pod调度控制。</li>
<li>基于污点来实现驱逐Pod，可以通过给节点打上污点，让不支持该污点的Pod被驱逐到其他节点上。</li>
</ul>
<h3 id="污点的配置支持下面三种类型"><a href="#污点的配置支持下面三种类型" class="headerlink" title="污点的配置支持下面三种类型"></a><strong>污点的配置支持下面三种类型</strong></h3><ul>
<li>NoSchedule 表示如果pod没有容忍这些污点，pod则法被调度到包含该污点的节点上。</li>
<li>PreferNoSchedule 相当于NoSchedule宽松的版本，在调度时会尽量阻止pod调度到具备PreferNoschedule 污点的节点上，但在没有其他节点可以提供调度的场景下。pod则可以被调度PreferNoschedule 污点的节点上。</li>
<li>NoExecute用于影响正在节点上运行的pod。如果当前节点上运行的pod没有容忍该节点上的NoExecute污点，则会Pod将会从该节点上去除。</li>
</ul>
<blockquote>
<p>上述的三种污点类型中，其中NoSchedule和PreferNoSchedule是用于控制Pod调度过程时的动作。而NoExecute则是影响调度后正在运行Pod的节点。</p>
</blockquote>
<h3 id="污点的配置示例"><a href="#污点的配置示例" class="headerlink" title="污点的配置示例"></a><strong>污点的配置示例</strong></h3><h4 id="添加污点示例"><a href="#添加污点示例" class="headerlink" title="添加污点示例"></a><strong>添加污点示例</strong></h4><p><code>kubectl taint node 主机名 key=value:污点类型 </code></p>
<blockquote>
<p> 在添加taint的时候，value字段是可以省略的。</p>
<p> 可以支持基于label来进行污点的添加删除，添加-l key&#x3D;value 选项即可实现</p>
<p> 污点支持的详细参数，可通过 <code>kubectl explain node.spec.taints</code> 查询。</p>
</blockquote>
<h4 id="移除污点示例"><a href="#移除污点示例" class="headerlink" title="移除污点示例"></a><strong>移除污点示例</strong></h4><p><code>kubectl taint node 主机名 key:污点类型-</code></p>
<blockquote>
<p>在移除污点时，key后面可以省略污点类型。这样做就会删除所有指定的key值污点。</p>
</blockquote>
<h4 id="污点作用测试"><a href="#污点作用测试" class="headerlink" title="污点作用测试"></a><strong>污点作用测试</strong></h4><p>当我们给节点添加上污点以后，可以怎么样去测试是否生效？这时候我们通过给Pod添加 <code>NodeSelector</code> 的配置，将Pod绑定到带污点的节点上。</p>
<p>添加 <code>NodeSelector</code> 的Pod配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">pod-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">nodeSelector:</span>   <span class="comment">#通过nodeSelector，将Pod调度到带有设置的key：value标签节点。此处标签为node=master</span></span><br><span class="line">    <span class="attr">node:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>

<p>查看调度结果，此时会打印出 <code>node(s) had taint</code>的事件。遇到这类的提示，可以确认一下Pod是否配置容忍，容忍的配置是否匹配环境等。</p>
<p>![image-20201116155117361](D:\My\学习\6. 笔记\3. 微服务\k8s\note_picture\调度.asserts\image-20201116155117361.png)</p>
<h4 id="污点配置案例"><a href="#污点配置案例" class="headerlink" title="污点配置案例"></a><strong>污点配置案例</strong></h4><p><strong>1.给k8s-node01节点添加上污点，使得创建Pod时，无法调度到该节点上。</strong></p>
<p><code>kubectl taint node k8s-node01 node-type=production:NoSchedule</code></p>
<p><strong>2.给具备 node-type&#x3D;gray 标签的节点添加污点，使得Pod创建时，不优先调度到这类节点上。</strong></p>
<p><code>kubectl taint node -l node-type=gray node-type=gray:PreferNoSchedule</code></p>
<p><strong>3.移除k8s-node01节点上key值为 node-type 的污点</strong></p>
<p><code>kubectl taint node k8s-node01 node-type</code></p>
<p><strong>4.为k8s-node01添加污点，直接驱逐未容忍该污点的Pod。</strong></p>
<p><code>kubectl taint node k8s-node01 node-type=drain:NoExecute</code></p>
<h3 id="容忍的配置示例"><a href="#容忍的配置示例" class="headerlink" title="容忍的配置示例"></a><strong>容忍的配置示例</strong></h3><p>tolerations支持如下配置</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>effect</td>
<td>effect可以填写污点的类型（NoSchedule，NoExecute等），当effect为空时，代表匹配key名称的所有污点类型。</td>
</tr>
<tr>
<td>key</td>
<td>指定容忍的污点key字段，当key值为空的场景（此时operator必须设置为Exists），则代表它匹配所有污点的key。</td>
</tr>
<tr>
<td>value</td>
<td>指定容忍的污点value字段，当operator设置为Exists的场景。此字段必须为空。</td>
</tr>
<tr>
<td>operator</td>
<td>支持Equal以及Exists两个参数。默认使用Equal，使用Exists时，只需要配置key字段，相当于key：*的匹配形式。使用Equal需要同时指定key和value值</td>
</tr>
<tr>
<td>tolerationSeconds</td>
<td>该字段作用于<code>NoExecute</code>，当节点打上了污点类型为<code>NoExecute</code>时，会驱逐没有容忍<code>NoExecute</code>的Pod。如果Pod指定了容忍<code>NoExecute</code>类型的同时，指定了<code>tolerationSeconds</code>选项。则Pod会等待<code>tolerationSeconds</code>设置的时间。再进行Pod驱逐。</td>
</tr>
</tbody></table>
<blockquote>
<p>通过如下命令可以查询tolerations可以支持的选项，以及选项的注释</p>
<p><code>kubectl explain deployment.spec.template.spec.tolerations</code></p>
</blockquote>
<h4 id="容忍配置案例"><a href="#容忍配置案例" class="headerlink" title="容忍配置案例"></a><strong>容忍配置案例</strong></h4><p><strong>1.添加容忍配置，允许Pod调度到节点标签为 node-type&#x3D;gray ，并且污点类型为 NoSchedule 的机器。</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">pod-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span>        <span class="comment">#设置污点类型为NoSchedule</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">&quot;node-type&quot;</span>        <span class="comment">#key值为node-type</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Equal</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;gray&quot;</span>            <span class="comment">#value值为Equal</span></span><br></pre></td></tr></table></figure>

<p><strong>2.添加容忍配置，允许Pod调度到任何打 上NoSchedule 污点类型的节点。</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">pod-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span>        <span class="comment">#设置污点类型为NoSchedule</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">&quot;&quot;</span>                    <span class="comment">#当key值为空，operator为Exists时，匹配任意key值</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br></pre></td></tr></table></figure>

<p><strong>3.添加容忍配置，允许Pod运行在具备 node-type&#x3D;gray 且污点类型为任意类型的节点上。</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">pod-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">&quot;&quot;</span>                <span class="comment">#设置污点类型为空，代表它支持任意污点类型</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">&quot;node-type&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Equal</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;gray&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>4.添加容忍配置，允许Pod运行在具有 node-type&#x3D;drain 且污点类型为 NoExecute 的节点上。</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">pod-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span>            <span class="comment">#设置污点类型为NoExecute，未容忍该污点的Pod直接被驱逐</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">&quot;node-type&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Equal</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;drain&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>5.添加容忍配置，允许Pod运行在具有 node-type&#x3D;drain 且污点类型为 NoExecute 的节点上，当300秒以后该污点依旧存在时，驱逐该Pod到其他节点。</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">pod-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span>            <span class="comment">#设置污点类型为NoExecute，未容忍该污点的Pod直接被驱逐</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">&quot;node-type&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Equal</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;drain&quot;</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="string">&quot;300&quot;</span>    <span class="comment">#设置容忍时间为300秒，当Pod所在的节点打上了node-type=drain:NoExecute的污点以后。该Pod会在该节点上继续运行300秒。300秒结束后污点依旧存在的话，驱逐该Pod。</span></span><br></pre></td></tr></table></figure>

<p>节点上是可以添加多个污点的，支持设置不同的污点类型。Pod同时也可以设置多个容忍。在这种场景下 kube-schedule 进行调度匹配时会以过滤器的形式来进行工作。相当于用污点减去容忍，结果为节点污点与Pod容忍之间的差集，再根据污点的差集结果来进行调度。</p>
<ul>
<li>经过滤以后，节点至少有一个 <code>effect</code> 为  <code>NoSchedule</code>  的污点时，Pod不调度到该类节点上。</li>
<li>经过滤以后，节点至少有一个<code>effect</code>为 <code>PreferNoSchedule</code> 的污点时，Pod可能调度到该类节点上。</li>
<li>经过滤以后，节点至少有一个 <code>effect </code>为 <code>NoExecute</code> 的污点时，Pod不调度到该类节点上。如果Pod存在于该节点，则进行驱逐。</li>
</ul>
<p><strong>关于tolerationSeconds的应用场景</strong></p>
<p>  为了维持集群的稳定性，当节点达到某种状态时，节点控制器会自动给节点添加污点，当前内置的污点类型如下：</p>
<table>
<thead>
<tr>
<th>污点key</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>node.kubernetes.io&#x2F;not-ready</td>
<td>节点状态未处于 <code>Ready</code></td>
</tr>
<tr>
<td>node.kubernetes.io&#x2F;unreachable</td>
<td>节点控制器访问不到节点. 这相当于节点状态  <code>Ready</code>  的值为 <code>Unknown</code></td>
</tr>
<tr>
<td>node.kubernetes.io&#x2F;out-of-disk</td>
<td>节点磁盘资源耗尽</td>
</tr>
<tr>
<td>node.kubernetes.io&#x2F;memory-pressure</td>
<td>节点存在内存压力</td>
</tr>
<tr>
<td>node.kubernetes.io&#x2F;disk-pressure</td>
<td>节点存在磁盘压力</td>
</tr>
<tr>
<td>node.kubernetes.io&#x2F;network-unavailable</td>
<td>节点网络不可达</td>
</tr>
<tr>
<td>node.kubernetes.io&#x2F;unschedulable</td>
<td>节点不可被调度</td>
</tr>
<tr>
<td>node.cloudprovider.kubernetes.io&#x2F;uninitialized</td>
<td>如果 kubelet 启动时指定了一个外部云平台，它将给当前节点添加一个污点将其标志为不可用。在 cloud-controller-manager 的一个控制器初始化这个节点后，kubelet 将删除这个污点。</td>
</tr>
</tbody></table>
<p>  当节点出现上述情况时，就节点控制器就会自动为节点添加上述类型的污点，当状态恢复正常时，节点控制器会自动清除污点。</p>
<p>  那什么时候我们可以使用 <code>tolerationSeconds </code>选项，当Pod所在的节点发生类如上述状态时，希望Pod能够暂时运行一段时间。则可以在 <code>tolerations</code> 配置中添加 <code>tolerationSeconds</code> 并设置合适的时间参数。这样做的好处是用于提升节点上Pod运行的稳定性。在生产的场景。可能节点出现了短暂的网络异常或者内存压力等等。这设置 <code>tolerationSeconds</code>可以避免节点上的Pod被直接驱逐。提升Pod运行的稳定性。</p>
<p>  默认情况下，Pod会被自动添加上 <code>node.kubernetes.io/not-ready</code> 以及 <code>node.kubernetes.io/unreachable</code> 的污点容忍。具体配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">300</span>  <span class="comment">#当节点出现 node.kubernetes.io/not-ready污点时，允许Pod继续运行5分钟</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node.kubernetes.io/unreachable</span>  <span class="comment">#当节点出现 node.kubernetes.io/unreachable污点时，允许Pod继续运行5分钟</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>  通过上述的两个容忍配置，可以避免Pod因为节点短暂出现 <code>NotReady</code> 或者 <code>UnKnown</code> 的状态而导致Pod被驱逐。 </p>
<blockquote>
<p>通过DaemonSet创建出来的Pod会将 <code>tolerationSeconds</code> 设置为0。 避免Pod被驱逐。</p>
</blockquote>
<hr>
<h2 id="亲和性与反亲和性"><a href="#亲和性与反亲和性" class="headerlink" title="亲和性与反亲和性"></a><strong>亲和性与反亲和性</strong></h2><p>  污点是用于避免Pod调度到特定节点上。而亲和性&#x2F;反亲和性是用来控制Pod调度到满足亲和性&#x2F;反亲和性策略的特定节点。亲和性策略在粒度上分为节点亲和性和Pod亲和性。在规则上分为标准和扩展两种。</p>
<h3 id="nodeName以及nodeSelector"><a href="#nodeName以及nodeSelector" class="headerlink" title="nodeName以及nodeSelector"></a><strong>nodeName以及nodeSelector</strong></h3><p>  <code>nodeName</code> 与 <code>nodeSelector</code> 是早期实现的方法，它们是 pod.spec 中可配置选项。通过这两个配置可以实现让 Pod 调度到特定的节点上。</p>
<p>  通过 <code>nodeName</code> 可以将 Pod 调度到满足节点名称的节点上。该操作是强制匹配，会跳过 schedule 的调度过程。所以 <code>nodeName</code> 的调度优先级是最高的。</p>
<p>  <code>nodeName</code> 的配置示例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">pod-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">k8s-node01</span>        <span class="comment">#设置nginx Pod必须调度到节点名称为k8s-node01的节点上。</span></span><br></pre></td></tr></table></figure>

<p>  <code>nodeSelector</code> 是基于节点标签来实现的约束调度。通过配置 <code>nodeSelector </code>选项，我们可以让Pod运行在满足标签要求的节点上。<code>nodeSelector</code> 作用于 <code>MatchNodeSelector</code> 过滤方法。</p>
<p>  <code>nodeSelector</code> 的配置示例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">pod-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">node-type:</span> <span class="string">gray</span>           <span class="number">2</span> <span class="comment">#设置pod调度时，只允许调度到带有node-type=gray标签的节点上。</span></span><br></pre></td></tr></table></figure>

<p>  通过 <code>nodeName</code> 和 <code>nodeSelector</code> 可以快速的实现节点约束，让Pod调度到特定的节点上。但是这两种方法的灵活性不足。比方说现在有一个场景，业务系统由前后端组件构成。一类用于提供前端业务呈现。一类用于实现后端逻辑运算。每类组件的Pod具备多个副本。一方面我们希望Pod的副本处于不同的节点，保证组件的可靠性和稳定性。另一方面我们希望前端业务Pod和后端业务Pod能够尽可能部署在相同节点上。降低跨服务器，交换机，机房场景带来的延迟，提升应用性能。此时我们单使用 <code>nodeName</code> 或者 <code>nodeSelector</code> 不易于实现该类场景部署。对于复杂的调度场景。我们可以使用扩展性更好的亲和类配置来实现Pod调度。</p>
<hr>
<h3 id="基于命名空间修改-nodeSelecctor-配置"><a href="#基于命名空间修改-nodeSelecctor-配置" class="headerlink" title="基于命名空间修改 nodeSelecctor 配置"></a>基于命名空间修改 nodeSelecctor 配置</h3><p>  可以通过为 apiserver 启用 <code>PodNodeSelector</code> 准入控制器，为特定命名空间增加特定的注解。让 apiserver 在接收该类命名空间下的创建请求的时候自动添加<code>nodeSelector</code> 配置。实现 Pod 调度控制。</p>
<p>  <strong>配置方法</strong></p>
<p>  启用准入控制器，在 kube-apiserver 的启动命令中添加 <code>--enable-admission-plugins=...(原始参数),PodNodeSelector</code> 参数。让它启用 <code>PodNodeSelector</code>  准入控制。</p>
<p>  参考如下示例，为命名空间添加注解<code>scheduler.alpha.kubernetes.io/node-selector·，其值为 </code>rack&#x3D;1<code>（注意必须为字符串），这样 demo 命名空间下创建的 Pod 就会自动添加上</code>nodeSelector 配置<code>，选择的标签是 </code>rack&#x3D;1&#96; 。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">scheduler.alpha.kubernetes.io/node-selector:</span> <span class="string">&quot;rack=1&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>准入控制是在apiserver这一层生效的。该命名空间下存量的 Pod 并不会因此自动添加上 nodeSelector 只有当新的创建请求出现时才会添加上。</p>
</blockquote>
<hr>
<h3 id="通过亲和配置实现Pod调度"><a href="#通过亲和配置实现Pod调度" class="headerlink" title="通过亲和配置实现Pod调度"></a><strong>通过亲和配置实现Pod调度</strong></h3><p>  亲和配置分为节点亲和以及 Pod 间亲和。通过节点亲和可以实现类似nodeSelector的能力。通过节点标签来控制让Pod调度到指定节点。而 Pod 间亲和则是通过 Pod 标签来控制。</p>
<blockquote>
<p>当前亲和性的配置仅在 Pod 调度期间工作，如果后续 Pod 被调度到的节点修改了标签将不会影响到Pod运行。</p>
</blockquote>
<h4 id="基于节点的亲和性调度"><a href="#基于节点的亲和性调度" class="headerlink" title="基于节点的亲和性调度"></a>基于节点的亲和性调度</h4><p>  当前节点亲和的可配置选项为 <code>requiredDuringSchedulingIgnoredDuringExecution</code> 以及 <code>preferredDuringSchedulingIgnoredDuringExecution</code> 两种。分别为软调度和硬调度的意思。</p>
<h5 id="基于requiredDuringSchedulingIgnoredDuringExecution实现节点亲和"><a href="#基于requiredDuringSchedulingIgnoredDuringExecution实现节点亲和" class="headerlink" title="基于requiredDuringSchedulingIgnoredDuringExecution实现节点亲和"></a><strong>基于requiredDuringSchedulingIgnoredDuringExecution实现节点亲和</strong></h5><p>  使用<code>requiredDuringSchedulingIgnoredDuringExecution</code> 可以实现类nodeSelector的能力。但是它支持的选项比nodeSelector更加丰富。</p>
<p>  <code>requiredDuringSchedulingIgnoredDuringExecution</code> 的示例配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">pod-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span>                            <span class="comment"># 使用 In 规则代表 value字段必须满足values的其中一个元素</span></span><br><span class="line">              <span class="attr">values:</span>                                <span class="comment"># values 字段属于数组，配置的时候允许多个元素</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&#x27;01&#x27;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&#x27;02&#x27;</span></span><br></pre></td></tr></table></figure>

<p>  通过上述的亲和度配置。实现的效果是，创建一个名称为 nginx 的 Pod ，设置 Pod 标签为 <code>run=nginx</code> ，运行在 pod-demo 命名空间下。配置硬亲和性调度，要求该 Pod 必须在具备 <code>app=01</code> 或 <code>app=02</code> 标签的节点上运行。</p>
<p>matchExpressions支持的选项如下</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>key</td>
<td>选择器所使用的标签键值</td>
</tr>
<tr>
<td>operator</td>
<td>有效的运算符有 In、NotIn、Exist、DoesNotExist 以及 GT 和 LT</td>
</tr>
<tr>
<td>values</td>
<td>当 operator 使用 In 或者 NotIn 时 values 字段必须非空。当operator使用 Exist 或者 DoestNotExist 时，该 values 字段必须为空。当 operator 使用 GT 或者 LT 时，values字段至少拥有一个元素。</td>
</tr>
</tbody></table>
<blockquote>
<p>使用 operator 中的 Exist 以及 DoestNotExist 相当于只需要判断节点标签的键值是否存在。</p>
<p>通过给operator使用 NotIn 或者 DoestNotExist 可以实现反亲和。</p>
</blockquote>
<p><code>requiredDuringSchedulingIgnoredDuringExecution</code> 下可以支持同时设置多个 <code>nodeSelectorTerms</code> ，单个 <code>nodeSelectorTerms</code>  可以同时设置多个 <code>matchExpressions</code> 。它们的匹配规则如下：</p>
<ul>
<li>同时指定多个 <code>nodeSelectorTerms</code> 的场景，当节点满足某一个 <code>nodeSelectorTerms</code>  的规则，即可被调度上。</li>
<li>当 <code>nodeSelectorTerms</code> 下同时指定了多个<code>matchExpressions</code>则节点需要满足所有的 <code>matchExpressions</code> 规则才能被调度上。</li>
</ul>
<h5 id="基于preferredDuringSchedulingIgnoredDuringExecution实现节点亲和"><a href="#基于preferredDuringSchedulingIgnoredDuringExecution实现节点亲和" class="headerlink" title="基于preferredDuringSchedulingIgnoredDuringExecution实现节点亲和"></a><strong>基于preferredDuringSchedulingIgnoredDuringExecution实现节点亲和</strong></h5><p>  <code>preferredDuringSchedulingIgnoredDuringExecution</code> 是一种软调度的方式，当节点满足 <code>preferredDuringSchedulingIgnoredDuringExecution</code> 设定的规则时，在打分阶段可以得到更多的分值。从而提升满足规则对应节点被调度的优先级。</p>
<p>  <code>preferredDuringSchedulingIgnoredDuringExecution</code> 的示例配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">pod-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">preference:</span></span><br><span class="line">            <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&#x27;01&#x27;</span></span><br></pre></td></tr></table></figure>

<p>  通过上述的亲和度配置。实现的效果是，创建一个名称为 nginx 的 Pod ，设置标签为 <code>run=nginx</code> ，运行在 pod-demo 命名空间下。配置软亲和性调度，要求该 Pod 优先在具备 <code>app=01</code> 标签的节点上运行，该规则的权重值为1。</p>
<p>  <code>preferredDuringSchedulingIgnoredDuringExecution</code> 下必须指定 <code>preference</code> 以及 <code>weight</code> 。 <code>weight</code> 代表权重，可配置的数字范围1~100。<code>weight</code> 字段越大，在 schedule 中的打分阶段加分越多。<code>preference</code> 下则指定 <code>matchExpressions</code> 表示加分需要满足的规则。可以指定多个 <code>matchExpressions</code> ，节点只要满足任一条件即可。</p>
<p>  <code>preferredDuringSchedulingIgnoredDuringExecution</code> 和 <code>requiredDuringSchedulingIgnoredDuringExecution</code>  这两个亲和性配置是可以结合使用的。通过 <code>requiredDuringSchedulingIgnoredDuringExecution</code> 可以限制 Pod 可调度的范围，再进一步通过 <code>preferredDuringSchedulingIgnoredDuringExecution</code> 决定节点优先运行在该范围的哪台节点上。</p>
<blockquote>
<p>​    在配置亲和性调度时，要注意 <code>topologyKey</code> 的使用，相同的业务副本要使用相同的 <code>topologyKey</code> 作为调度拓扑的基准。否则会产生未知的调度情况。导致 Pod 副本不符合要求。</p>
</blockquote>
<h5 id="节点亲和性的配置案例"><a href="#节点亲和性的配置案例" class="headerlink" title="节点亲和性的配置案例"></a><strong>节点亲和性的配置案例</strong></h5><p>1.添加亲和性配置，要求 Pod 必须调度到键值为 product 标签的节点上。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">pod-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">product</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">Exist</span></span><br><span class="line">              <span class="attr">values:</span> <span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>2.添加亲和性配置，要求 Pod 优先调度到具备 AZ1或者 AZ2 标签的节点。次优调度到 AZ3 的节点</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">pod-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">daocloud.io/nginx</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">availibity-zone</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&#x27;az1&#x27;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&#x27;az2&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">20</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">availibity-zone</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&#x27;az3&#x27;</span></span><br></pre></td></tr></table></figure>

<p>3.添加亲和性配置，要求 Pod 必须调度到带有 <code>dpdk=true</code> 的节点上。 并且优先调度到 AZ1 标签的节点。次优AZ2。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">pod-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">daocloud.io/nginx</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">dpdk</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">availibity-zone</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&#x27;az1&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">60</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">availibity-zone</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&#x27;az2&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="基于Pod的亲和性调度"><a href="#基于Pod的亲和性调度" class="headerlink" title="基于Pod的亲和性调度"></a>基于Pod的亲和性调度</h4><p>  通过基于节点的亲和性调度，我们可以实现类 <code>nodeSelector</code> 的能力，但具备更强的扩展性。上文提到了一种场景。在部署业务的时候划分了前端业务 Pod 和后端业务 Pod 。我们希望这两种 Pod 能够运行在相同的节点上。单通过节点亲和性调度。没办法很好的满足该场景。此时可以使用 Pod 亲和性调度来实现。</p>
<p>  通过 pod 亲和调度规则，可以实现基于已经在节点上运行的 pod 的标签来约束 pod 可以调度到的节点，而不是基于节点上的标签来约束。pod 亲和调度规则和节点亲和调度规则相同，具备<code>requiredDuringSchedulingIgnoredDuringExecution</code> 和 <code>preferredDuringSchedulingIgnoredDuringExecution</code>，分表表示硬性与软性要求。</p>
<p>  Pod间亲和规则引入 <code>topologyKey</code> 的选项，用于标识节点位置。通过设置 <code>topologyKey</code> 来决定被调度的节点是否为同一位置。来控制 Pod 的分布。我们可以将节点、机柜、机房、数据中心等作为 <code>topologyKey</code> 调度的粒度，为节点规划好对应的标签与值。</p>
<blockquote>
<p>  在使用 Pod 间反亲和性调度时，规划使用的 topologyKey 必须要在所有节点都具备，如果某些或所有节点缺少指定的 topologyKey 标签，可能会出现意外情况。Pod 可能会调度到未具备 topologyKey 的节点上。</p>
</blockquote>
<h5 id="Pod亲和性调度的配置示例"><a href="#Pod亲和性调度的配置示例" class="headerlink" title="Pod亲和性调度的配置示例"></a>Pod亲和性调度的配置示例</h5><p>  首先创建 frontend pod，提交下述的示例 YAML 创建资源，会在 default 命名空间下 创建一个名称为 frontend-pod 的 Pod。该 Pod 具备 <code>app=frontend</code> 的标签。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/nginx</span></span><br></pre></td></tr></table></figure>

<p>  然后创建一个 backend pod，提交下述的示例 YAML 创建资源，会在 default 命名空间下 创建一个名称为 backend-pod 的 Pod。该 Pod 具备 <code>app=backend</code> 的标签。 并且该 Pod 必须在带有 <code>app=frontend</code> 标签的 Pod 所运行的节点上运行。调度的拓扑域以<code>kubernetes.io/hostname</code> 为基准。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">backend-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">backend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">frontend</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/nginx</span></span><br></pre></td></tr></table></figure>

<p>  最后创建名称为 frontend pod1 的 Pod ，提交下述的示例 YAML 创建资源， 要求该 Pod 不能在带有 <code>app=frontend</code> 标签的 Pod 所运行的节点上运行。调度的拓扑域以 <code>kubernetes.io/hostname</code> 为基准。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend-pod1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAntiAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">frontend</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">daocloud.io/nginx</span></span><br></pre></td></tr></table></figure>

<p>  在kubernetes集群上执行上述动作以后。会产生三个 Pod ，其中 frontend pod 与 backend pod 会调度到相同的节点上。frontend  pod 和 frontend pod1 会在不同的节点上运行。</p>
<p><strong>通过 Pod 亲和性配置，优化前后端业务Pod部署</strong></p>
<p>  上文提到一个场景，业务系统由前后端组件构成。一类用于提供前端业务呈现。一类用于实现后端逻辑运算。每类组件的Pod具备多个副本。前后端 Pod 运行在同一个节点上。并且 Pod 副本分布在不同的节点上。现在可以通过 Pod 亲和性配置来实现该需求。</p>
<p>  创建前端业务 deployment ，提交下述的示例 YAML 创建资源，在 default 命名空间下创建名为 frontend-pod 的 deployment。并且设置标签为 <code>app=frontend</code> 。设置反亲和性规则，以 <code> kubernetes.io/hostname</code> 标签键值为调度基准。 要求该Deployment 创建 Pod 出的 Pod 不能运行在已带有 <code>app=frontend</code> 标签的 Pod 所运行的节点上。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">frontend</span></span><br><span class="line">            <span class="attr">topologyKey:</span> <span class="string">&quot;kubernetes.io/hostname&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backend</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/nginx</span></span><br></pre></td></tr></table></figure>

<p>  创建后端业务 deployment ，提交下述的示例 YAML 创建资源，在 default 命名空间下创建名为 backend-pod 的 deployment。并且设置标签为 <code>app=backend</code> 。设置亲和性规则，以 <code> kubernetes.io/hostname</code> 标签键值为调度基准。 要求该Deployment 创建 Pod 出的 Pod 必须运行在已带有 <code>app=frontend</code> 标签的 Pod 所运行的节点上。设置反亲和性规则，以 <code> kubernetes.io/hostname</code> 标签键值为调度基准。 要求该Deployment 创建 Pod 出的 Pod 不能运行在已带有 <code>app=backend</code> 标签的 Pod 所运行的节点上。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">backend-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">backend</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">frontend</span></span><br><span class="line">            <span class="attr">topologyKey:</span> <span class="string">&quot;kubernetes.io/hostname&quot;</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line">            <span class="attr">topologyKey:</span> <span class="string">&quot;kubernetes.io/hostname&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backend</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/nginx</span></span><br></pre></td></tr></table></figure>

<p>  通过上述两个动作，可以创建将前端业务 Pod 与 后端业务 Pod 的副本分布在三台不同的节点上。 并且前端业务 Pod 和 后端业务 Pod 会在相同的节点上运行。</p>
<hr>
<h3 id="Pod-拓扑约束"><a href="#Pod-拓扑约束" class="headerlink" title="Pod 拓扑约束"></a>Pod 拓扑约束</h3><p><strong>关于 topologySpreadConstraints 机制</strong></p>
<p>   上文提到的 nodeSelector、Affinity等机制都可以用于控制 Pod 调度。让 Pod 的分布符合预期。而不是随机散放在各个节点上。其中Affinity具备强大的扩展能力。可以很好的设置多个条件。让 Pod 调度能够实现复杂的亲和、反亲和场景。</p>
<p>  但是仅通过Affinity方法还不能满足某些场景下调度分布的需求。我们可以假设一种场景。现在有一个应用，它具备 4 个 Pod 副本。同时我们集群的服务器节点分布在不同的机架上。考虑到机柜级可靠性。我们需要将 4 个 Pod 副本尽可能的分布到不同的机架上。这个时候，我们是否可以如何通过 Affinity 配置来完成该项需求？</p>
<p>  首先我们现在的调度粒度希望是机柜级。给不同机柜的机器打上标签。此时一个拓扑域等同于一个机架。假设我们现在拥有一个 3 节点的kubernetes集群。节点分布在不同的机柜上。我们通过执行如下命令来完成配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node k8s-master rack=1</span><br><span class="line">kubectl label node k8s-node01 rack=1</span><br><span class="line">kubectl label node k8s-node02 rack=2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>​    为了模拟现实环境，给节点打上了 rack 标签，后续基于 rack 标签作为拓扑域调度。应反亲和性调度的要求， Topologykey 必须是所有节点都需要拥有的标签健。</p>
</blockquote>
<p>  此时节点标签如下</p>
<p>![image-20201128170755258](D:\My\学习\6. 笔记\3. 微服务\k8s\note_picture\kubernetes调度控制场景与配置方法.asserts\image-20201128170755258.png)</p>
<p>  通过给节点打上标签，相当于描述这两个节点位于不同的机架。现在通过如下 YAML 创建业务 Pod 。Pod 具备 4 个副本。并且要求分布在不同的机架上。这个时候我们可以尝试使用 Anti-Affinity 来完成该需求。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">business-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">business</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">business</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">business</span></span><br><span class="line">            <span class="attr">topologyKey:</span> <span class="string">&quot;rack&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">business</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/nginx</span></span><br></pre></td></tr></table></figure>

<p>  执行完成以后，我们会发现，只有两个 Pod 处于 <code>Running</code> 状态，而另外两个则处于 <code>Pending</code> 状态</p>
<p>![image-20201128171200049](D:\My\学习\6. 笔记\3. 微服务\k8s\note_picture\kubernetes调度控制场景与配置方法.asserts\image-20201128171200049.png)</p>
<p>  在编写 YAML 的时候我们可以发现，我们的拓扑粒度是基于 rack 标签的。反亲和调度在执行的时候，它只会确保每个拓扑拥有一个 Pod  副本。但是我们现在只有两个机柜。 这样一个机柜至少要运行两个 Pod 才能满足我们的期望。 此时 Anti-Affinity 的缺陷就暴露出来了。它虽然能够满足反亲和配置。但是没有办法控制 Pod 在 拓扑上分布的数量。在多数据中心冗余，单一数据中心多副本的场景下。我们是不能很好的通过 Anti-ffinity 来完成该要求的。 </p>
<p>  我们修改上述的 YAML 配置，先删除原有的 deployment。执行如下 YAML 清单创建资源</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">business-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">business</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">business</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">topologySpreadConstraints:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">maxSkew:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">rack</span></span><br><span class="line">        <span class="attr">whenUnsatisfiable:</span> <span class="string">DoNotSchedule</span></span><br><span class="line">        <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchLabels:</span></span><br><span class="line">            <span class="attr">app:</span> <span class="string">business</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backend</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/nginx</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>​    注意：topologySpreadConstraints 是在 v1.18 以后的版本才会默认打开。 之前的版本需要手动给 kube-apiserver 以及 kube-scheduler 添加 –feature-gates&#x3D;EvenPodsSpread&#x3D;true 的参数才能启用。</p>
</blockquote>
<p>  查看当前 Pod 的创建情况，从查询结果来看，Pod 似乎均匀的分布在了两个机柜上。</p>
<p>![image-20201128171934079](D:\My\学习\6. 笔记\3. 微服务\k8s\note_picture\kubernetes调度控制场景与配置方法.asserts\image-20201128171934079.png)</p>
<p>  查询kube-schedule日志我们可以看到，这次 Pod 创建的时候是有通过 spreadConstraint 去筛选节点的。避免 Pod 堆叠在某一个拓扑域上。实现了 Pod 打散。</p>
<p>![image-20201128171918527](D:\My\学习\6. 笔记\3. 微服务\k8s\note_picture\kubernetes调度控制场景与配置方法.asserts\image-20201128171918527.png)</p>
<p>  个人理解，spreadConstraint 计算过程大致如下，首先有这么几个变量</p>
<ul>
<li><p>MatchNum 节点当前拓扑具备条件的 Pod 数量</p>
</li>
<li><p>selfMatchNum 被调度的 Pod 是否满足 <code>topologySpreadConstraints</code> 中设置的 <code>labelSelector</code> 标签。如果满足则为 1</p>
</li>
<li><p>minMatchNum 在全局拓扑中具备满足条件 Pod 数量的最小值</p>
</li>
<li><p>maxSkew 在不同拓扑域中不均匀分布的最大程度</p>
<p>分析 <code>node &#39;k8s-node02&#39; failed spreadConstraint[rack]: MatchNum(1) + selfMatchNum(1) - minMatchNum(0) &gt; maxSkew(1) </code> 当时的计算场景。</p>
<p>MatchNum(1)，代表当前 k8s-node02 节点所在的拓扑域已经拥有 1 个满足条件的 Pod 。selfMatchNum(1)，表示本次待调度的 Pod 满足 <code>topologySpreadConstraints</code> 中设置的 <code>labelSelector</code> 标签。minMatchNum(0) 意味着当前拓扑域 rack&#x3D;1 当时具备满足条件的 Pod 数量为 0 。 此时计算结果，k8s-node02 所在节点的拓扑域 Skew 为 2。大于 maxSkew。此时 Pod 将不会调度到 k8s-node02。</p>
</li>
</ul>
<p>​    </p>
<p><strong>PodTopologySpread</strong>  选项解释</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">topologySpreadConstraints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">maxSkew:</span> <span class="string">&lt;integer&gt;</span></span><br><span class="line">      <span class="attr">topologyKey:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">      <span class="attr">whenUnsatisfiable:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">      <span class="attr">labelSelector:</span> <span class="string">&lt;object&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>maxSkew</strong> 描述 Pod 分布不均的程度。这是给定拓扑类型中任意两个拓扑域中 匹配的 pod 之间的最大允许差值。它必须大于零。取决于的 <code>whenUnsatisfiable</code> 取值，其语义会有不同。<ul>
<li>当 <code>whenUnsatisfiable</code> 等于 “DoNotSchedule” 时，<code>maxSkew</code> 是目标拓扑域 中匹配的 Pod 数与全局最小值之间可存在的差异。</li>
<li>当 <code>whenUnsatisfiable</code> 等于 “ScheduleAnyway” 时，调度器会更为偏向能够降低 偏差值的拓扑域。</li>
</ul>
</li>
<li><strong>topologyKey</strong> 是节点标签的键。如果两个节点使用此键标记并且具有相同的标签值， 则调度器会将这两个节点视为处于同一拓扑域中。调度器试图在每个拓扑域中放置数量 均衡的 Pod。</li>
<li><strong>whenUnsatisfiable</strong>，指示如果 Pod 不满足分布约束时如何处理：<ul>
<li><code>DoNotSchedule</code>（默认）告诉调度器不要调度。</li>
<li><code>ScheduleAnyway</code> 告诉调度器仍然继续调度，只是根据如何能将偏差最小化来对 节点进行排序。</li>
</ul>
</li>
<li><strong>labelSelector</strong> 用于查找匹配的 pod。匹配此标签的 Pod 将被统计，以确定相应 拓扑域中 Pod 的数量。</li>
</ul>
<p><strong>多<code>topologySpreadConstraints</code> 调度的例子</strong></p>
<p>  通过上述的例子，可以知道 <code>topologySpreadConstraints</code> 可以实现对 Pod 拓扑分布的数量控制。满足某些场景下的 Pod 分布需求。 它还支持多<code>topologySpreadConstraints</code>，进一步的控制 Pod 的分布。比方说我们现在有两个 AZ，希望创建的 Pod 首先需要分布在两个 AZ 下。在 AZ 内部我们又有多个 rack ，我们希望他在 AZ 内又分布在不同的 rack 下。这样做的好处是，不仅实现了跨 AZ 的分布。还避免了 Pod 堆叠在某一个机架上。</p>
<p>  大致的操作示例如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">business-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">business</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">business</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">topologySpreadConstraints:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">maxSkew:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">az</span></span><br><span class="line">        <span class="attr">whenUnsatisfiable:</span> <span class="string">DoNotSchedule</span></span><br><span class="line">        <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchLabels:</span></span><br><span class="line">            <span class="attr">app:</span> <span class="string">business</span></span><br><span class="line">      <span class="attr">topologySpreadConstraints:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">maxSkew:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">rack</span></span><br><span class="line">        <span class="attr">whenUnsatisfiable:</span> <span class="string">DoNotSchedule</span></span><br><span class="line">        <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchLabels:</span></span><br><span class="line">            <span class="attr">app:</span> <span class="string">business</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backend</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/nginx</span></span><br></pre></td></tr></table></figure>

<p><strong>与亲和性调度搭配工作的例子</strong></p>
<p>  <code>topologySpreadConstraints</code> 默认是从所有节点上搜寻 Topologykey的，我们可以结合 <code>nodeSelector</code> 或者 <code>nodeAffinity</code> 筛选符合条件的节点。减少<code>topologySpreadConstraints</code> 需要匹配的节点数量，并且将 Pod 分布控制在某一维度。使用下面的例子可以实现，创建 business-pod 将其均衡分布在带有 <code>rack=1</code> 或者 <code>rack=2</code>的节点上。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">business-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">business</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">business</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">topologySpreadConstraints:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">maxSkew:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">rack</span></span><br><span class="line">        <span class="attr">whenUnsatisfiable:</span> <span class="string">DoNotSchedule</span></span><br><span class="line">        <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchLabels:</span></span><br><span class="line">            <span class="attr">app:</span> <span class="string">business</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">rack</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">                <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backend</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">daocloud.io/nginx</span></span><br></pre></td></tr></table></figure>

<hr>
<p><strong>参考链接：</strong></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-topology-spread-constraints/">https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-topology-spread-constraints/</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1639217">https://cloud.tencent.com/developer/article/1639217</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/v1.17.0/pkg/scheduler/algorithm/predicates/predicates.go">https://github.com/kubernetes/kubernetes/blob/v1.17.0/pkg/scheduler/algorithm/predicates/predicates.go</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/podaffinity.md">https://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/podaffinity.md</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/K8S/" rel="tag"># K8S</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/09/13/tkestack%E6%89%A9%E5%AE%B9%E8%8A%82%E7%82%B9%E5%A4%B1%E8%B4%A5%E6%8E%92%E6%9F%A5%E6%8C%87%E5%BC%95/" rel="prev" title="tkestack扩容节点失败排查指引">
                  <i class="fa fa-angle-left"></i> tkestack扩容节点失败排查指引
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/01/17/Evicted/" rel="next" title="Pod 状态 Evicted 处理思路">
                  Pod 状态 Evicted 处理思路 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">guoltan</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
